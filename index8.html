<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<title>Watch Together</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script src="https://www.youtube.com/iframe_api"></script>

<style>
/* CSS STYLY */
html, body {
  height: 100%; 
  margin: 0;
}
body {
  background:#0d0d0d;
  color:white;
  font-family:Arial;
  display:flex;
}
#sidebar {
  width:260px;
  background:#111;
  display:flex;
  flex-direction:column;
  padding:10px;
  position: relative;
  z-index: 10; 
}
#main {
  flex:1;
  display:flex;
  flex-direction:column;
  /* Červený rámeček */
  border: 4px solid red; 
  height: 100%; 
  min-height: 0;
}
button,input {
  padding:8px;
  margin:4px 0;
  border:none;
  border-radius:4px;
}
/* Styly pro tlačítko Načíst/PLAY */
.control-button {
    font-weight: bold;
    cursor:pointer;
    padding: 8px 12px;
}
.control-button.yellow {
    background: #ffc107; /* Žlutá */
    color: #333;
    width: 100%; 
    text-align: center;
}
.control-button:hover { opacity:0.9; }
.control-button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

input {
  background:#222;
  color:white;
}
#videoControls input {
    width: calc(100% - 18px); 
}
#users-container {
    margin-top: 15px; 
    flex-grow: 1; 
    overflow-y: auto;
}
#users {
  margin-top:6px;
  overflow:visible; 
  padding: 0;
  list-style: none;
}
#users li {
  padding: 4px 0;
  border-bottom: 1px dotted #333;
}
#player {
  flex:1;
  background:black;
  width: 100%;
  height: 100%;
}
.small { font-size:13px; color:#aaa; }

.hidden { 
    display: none !important; 
} 

.dialog-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
}
.dialog-box {
    background: #222;
    padding: 20px;
    border-radius: 8px;
    text-align: center;
}
.dialog-box input {
    margin-bottom: 10px;
}
.dialog-box label {
    font-size: 14px;
    display: block;
    margin-top: 10px;
}
</style>
</head>

<body>

<div id="sidebar">

    <div id="videoControls" style="margin-top: 5px; margin-bottom: 5px;">
        <div class="small">YT Link:</div>
        <input id="videoUrl" placeholder="Vložit YouTube odkaz" autocomplete="off">
        <button id="loadVideoBtn" class="control-button yellow" onclick="loadVideo()">▶️ NAČÍST VIDEO</button>
    </div>
    
    <div style="margin-top: 10px; margin-bottom: 20px; font-size: 14px; display: flex; align-items: center;">
        <input type="checkbox" id="allowControl" style="margin: 0 5px 0 0;">
        <label for="allowControl" style="margin: 0; padding: 0;">Povolit ostatním ovládat</label>
    </div>

    <div id="users-container">
        <div class="small">Připojení lidé:</div>
        <ul id="users">
            </ul>
    </div>

</div>

<div id="main">
    <div id="player"></div>
</div>

<div id="nameDialog" class="dialog-overlay hidden">
    <div class="dialog-box">
        <h2>Ahoj!</h2>
        <input type="text" id="inputName" placeholder="Zadej prosím své jméno" autocomplete="off">
        <label>
            <input type="checkbox" id="rememberName"> Zapamatovat jméno
        </label>
        <button onclick="submitName()">Potvrdit</button>
    </div>
</div>

<script>
// ================= FIREBASE KONFIGURACE =================
const firebaseConfig = {
  apiKey: "AIzaSyBn6sJX5f9MIIXUSBWJDEc2zsDkr5Z7O0o",
  authDomain: "watchtogether-e67a5.firebaseapp.com",
  databaseURL: "https://watchtogether-e67a5-default-rtdb.firebaseio.com",
  projectId: "watchtogether-e67a5",
  storageBucket: "watchtogether-e67a5.firebasestorage.app",
  messagingSenderId: "928834764710",
  appId: "1:928834764710:web:2b2bc562d7dd6f0e33d967",
  measurementId: "G-CN7C9VT3GG"
};

try {
    firebase.initializeApp(firebaseConfig);
} catch (error) {
    console.log("Firebase already initialized");
}
const db = firebase.database();

// ================= GLOBAL & SETUP =================
const room = "room123"; 
let name = null;
let userRef = null;
let player = null;
let isApplyingState = false; 
let lastVideoID = null; 
let pendingState = null;
let isHost = false; 
let playerReady = false;

// ================= INICIALIZACE =================
window.onload = function() {
    if (localStorage.getItem("name") === "Anonymní divák") {
        localStorage.removeItem("name");
    }
    
    name = localStorage.getItem("name");

    if (name) {
        joinInternal();
    } else {
        document.getElementById('nameDialog').classList.remove('hidden');
        document.getElementById('inputName').focus();
    }

    // Přidat event listener pro Enter v input poli
    document.getElementById('videoUrl').addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !document.getElementById('loadVideoBtn').disabled) {
            loadVideo();
        }
    });
};

function submitName() {
    const inputField = document.getElementById('inputName');
    const rememberCheckbox = document.getElementById('rememberName');
    
    let tempName = inputField.value.trim();
    
    if (tempName === "") {
        alert("Prosím zadej své jméno, nemůže být prázdné.");
        return;
    }
    
    name = tempName;

    db.ref(`rooms/${room}/users`).once('value').then(snapshot => {
        let nameExists = false;
        snapshot.forEach(user => {
            if (user.val() === name) {
                nameExists = true;
            }
        });

        if (nameExists) {
            alert(`Jméno '${name}' už je v místnosti! Zkus prosím jiné.`);
        } else {
            if (rememberCheckbox.checked) {
                localStorage.setItem("name", name);
            } else {
                localStorage.removeItem("name");
            }
            
            document.getElementById('nameDialog').classList.add('hidden');
            joinInternal();
        }
    }).catch(error => {
        console.error("Error checking name:", error);
        alert("Chyba při připojování k místnosti");
    });
}

// ================= YOUTUBE API =================
function onYouTubeIframeAPIReady() {
    player = new YT.Player("player", {
        width: "100%",
        height: "100%",
        playerVars: {
            'playsinline': 1,
            'enablejsapi': 1,
            'origin': window.location.origin
        },
        events: { 
            onReady: onPlayerReady,
            onStateChange: onPlayerState,
            onError: onPlayerError
        }
    });
}

function onPlayerReady(event) {
    playerReady = true;
    
    db.ref(`rooms/${room}/state`).once('value').then(snap => {
        if (snap.exists()) {
            const state = snap.val();
            if (state && state.videoID) {
                applyState(state);
            }
        }
    }).catch(error => {
        console.error("Error loading initial state:", error);
    });
}

function onPlayerError(event) {
    console.error("YouTube Player Error:", event.data);
}

function extractVideoID(url) {
    if (!url) return null;
    const patterns = [
        /(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([^&?#]+)/,
        /youtube\.com\/watch\?.*v=([^&?#]+)/,
        /youtu\.be\/([^&?#]+)/
    ];
    for (let pattern of patterns) {
        const match = url.match(pattern);
        if (match && match[1]) {
            return match[1];
        }
    }
    return null;
}

// ================= OVLÁDÁNÍ A SETUP =================
function setupControls() {
    const controlSwitch = document.getElementById('allowControl');
    const roomControlRef = db.ref(`rooms/${room}/controlsEnabled`);
    const loadBtn = document.getElementById('loadVideoBtn');

    if (isHost) {
        controlSwitch.disabled = false;
        
        roomControlRef.once('value').then(snap => {
            const enabled = snap.val() === true;
            controlSwitch.checked = enabled;
            updateControlStates(enabled);
        });

        controlSwitch.addEventListener('change', () => {
            const enabled = controlSwitch.checked;
            roomControlRef.set(enabled);
            updateControlStates(enabled);
        });
    } else {
        controlSwitch.disabled = true;
        
        roomControlRef.on('value', snap => {
            const enabled = snap.val() === true;
            controlSwitch.checked = enabled;
            updateControlStates(enabled);
        });
    }
    
    function updateControlStates(enabled) {
        const canControl = isHost || enabled;
        loadBtn.disabled = !canControl;
        
        if (loadBtn.disabled) {
            loadBtn.title = "Nemáte oprávnění načíst video";
        } else {
            loadBtn.title = "Načíst video";
        }
    }
}

function joinInternal() {
    userRef = db.ref(`rooms/${room}/users`).push(name);
    userRef.onDisconnect().remove();
    
    db.ref("rooms/" + room).get().then(snapshot => {
        if (!snapshot.exists()) {
            isHost = true;
            
            const initialState = {
                users: { [userRef.key]: name },
                state: {
                    playing: false, 
                    time: 0, 
                    ts: Date.now(), 
                    videoID: "dQw4w9WgXcQ"
                },
                controlsEnabled: false
            };
            
            return db.ref("rooms/" + room).set(initialState);
        } else {
            isHost = false;
            return Promise.resolve();
        }
    }).then(() => {
        setupControls();
        listenRoom();
    }).catch(error => {
        console.error("Error joining room:", error);
        alert("Chyba při připojování k místnosti");
    });
}

window.addEventListener("beforeunload", () => {
    if (userRef) {
        userRef.remove();
    }
});

// ================= VYLEPŠENÁ SYNCHRONIZACE =================
function applyState(data) {
    if (!data || !player || !playerReady) {
        return;
    }
    
    if (isApplyingState) {
        return;
    }
    
    isApplyingState = true;
    
    const { playing, time, ts, videoID } = data;
    const localState = player.getPlayerState();
    const videoChanged = lastVideoID !== videoID;

    // 1. Změna videa
    if (videoChanged && videoID) {
        lastVideoID = videoID;
        pendingState = { playing, time, ts, videoID };
        
        player.loadVideoById(videoID);
        setTimeout(() => { isApplyingState = false; }, 1000);
        return;
    }

    // 2. Aplikace pending stavu po načtení videa
    if (pendingState && pendingState.videoID === videoID) {
        if ([YT.PlayerState.PLAYING, YT.PlayerState.PAUSED, YT.PlayerState.BUFFERING, YT.PlayerState.CUED].includes(localState)) {
            player.seekTo(pendingState.time, true);
            
            setTimeout(() => {
                if (pendingState.playing && localState !== YT.PlayerState.PLAYING) {
                    player.playVideo();
                } else if (!pendingState.playing && localState !== YT.PlayerState.PAUSED) {
                    player.pauseVideo();
                }
                pendingState = null;
            }, 500);
        }
    }

    // 3. Synchronizace času a stavu
    if (!videoChanged && [YT.PlayerState.PLAYING, YT.PlayerState.PAUSED, YT.PlayerState.BUFFERING].includes(localState)) {
        const delay = (Date.now() - ts) / 1000;
        const syncTime = time + delay + 0.2;
        const currentTime = player.getCurrentTime();
        const timeDiff = Math.abs(currentTime - syncTime);

        if (timeDiff > 2.0) {
            player.seekTo(syncTime, true);
        }
        
        if ((playing && localState !== YT.PlayerState.PLAYING) || 
            (!playing && localState !== YT.PlayerState.PAUSED)) {
            if (playing) {
                player.playVideo();
            } else {
                player.pauseVideo();
            }
        }
    }

    setTimeout(() => { isApplyingState = false; }, 500);
}

function listenRoom() {
    // Sledovat změny v seznamu uživatelů
    db.ref(`rooms/${room}/users`).on("value", snap => {
        const usersList = document.getElementById('users');
        usersList.innerHTML = "";
        
        snap.forEach(user => {
            const li = document.createElement("li");
            li.textContent = user.val();
            usersList.appendChild(li);
        });
    });

    // Sledovat změny stavu videa
    db.ref(`rooms/${room}/state`).on("value", snap => {
        if (snap.exists()) {
            applyState(snap.val());
        }
    });
}

// ================= VIDEO CONTROLS =================
function loadVideo() {
    const urlInput = document.getElementById('videoUrl');
    const videoUrl = urlInput.value.trim();
    
    if (!videoUrl) {
        alert("Prosím vložte YouTube odkaz");
        return;
    }
    
    const id = extractVideoID(videoUrl);
    if (!id) {
        alert("Neplatný YouTube odkaz. Zkontrolujte formát URL.");
        return;
    }
    
    const controlsEnabled = document.getElementById('allowControl').checked;
    if (!isHost && !controlsEnabled) {
        alert("Pouze host nebo uživatelé s povoleným ovládáním mohou načíst video.");
        return;
    }
    
    // Odeslat nový stav do Firebase
    const newState = {
        playing: true,
        time: 0,
        ts: Date.now(),
        videoID: id 
    };
    
    db.ref(`rooms/${room}/state`).set(newState)
        .then(() => {
            urlInput.value = ""; // Vyčistit input
        })
        .catch(error => {
            console.error("Error updating video state:", error);
            alert("Chyba při načítání videa");
        });
}

function onPlayerState(event) {
    if (isApplyingState || !room || !userRef || !playerReady) return;
    
    if ([YT.PlayerState.CUED, YT.PlayerState.ENDED, YT.PlayerState.UNSTARTED, YT.PlayerState.BUFFERING].includes(event.data)) {
        return;
    }
    
    const controlsEnabled = document.getElementById('allowControl').checked;
    if (!isHost && !controlsEnabled) {
        return;
    }

    // Synchronizovat pouze při PLAYING/PAUSED
    if (event.data === YT.PlayerState.PLAYING || event.data === YT.PlayerState.PAUSED) {
        const currentTime = player.getCurrentTime();
        
        const stateUpdate = {
            playing: event.data === YT.PlayerState.PLAYING,
            time: currentTime,
            ts: Date.now(),
            videoID: lastVideoID 
        };
        
        db.ref(`rooms/${room}/state`).set(stateUpdate)
            .catch(error => {
                console.error("Error updating playback state:", error);
            });
    }
}
</script>

</body>
</html>
