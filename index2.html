<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="utf-8"/>
<title>Watch Together - oprava join</title>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script src="https://www.youtube.com/iframe_api"></script>
<style>
body{margin:0;background:#0d0d0d;color:#fff;font-family:Arial;display:flex;height:100vh}
#sidebar{width:260px;background:#111;display:flex;flex-direction:column;padding:10px}
#main{flex:1;display:flex;flex-direction:column;padding:10px}
button,input{padding:8px;margin:6px 0;border-radius:6px;border:none}
button{background:#2563eb;color:#fff;cursor:pointer}
button.red{background:#b91c1c}
input{background:#222;color:#fff}
#users{flex:1;overflow:auto;margin:6px 0;padding-left:18px}
#player{flex:1;background:#000}
.code{background:#222;padding:6px;border-radius:6px;text-align:center;margin:6px 0;font-weight:bold}
.hidden{display:none}
.small{font-size:13px;color:#aaa}
</style>
</head>
<body>

<div id="sidebar">
  <div id="authBtns">
    <button id="createBtn">Vytvořit místnost</button>
    <button id="joinBtn">Připojit se</button>
  </div>

  <div id="connectedBtns" class="hidden">
    <button id="disconnectBtn" class="red">Odpojit se</button>
  </div>

  <div id="roomInfo" class="hidden">
    <div class="small">Kód místnosti:</div>
    <div id="roomCode" class="code"></div>
  </div>

  <div class="small">Připojení lidé:</div>
  <ul id="users"></ul>

  <div id="videoControls" class="hidden" style="margin-top:auto">
    <input id="videoUrl" placeholder="YouTube odkaz nebo ID"/>
    <button id="loadBtn">Načíst video</button>
  </div>
</div>

<div id="main">
  <div id="player"></div>
</div>

<script>
// -------- FIREBASE CONFIG (TVŮJ) ----------
const firebaseConfig = {
  apiKey: "AIzaSyBn6sJX5f9MIIXUSBWJDEc2zsDkr5Z7O0o",
  authDomain: "watchtogether-e67a5.firebaseapp.com",
  databaseURL: "https://watchtogether-e67a5-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "watchtogether-e67a5",
  storageBucket: "watchtogether-e67a5.appspot.com",
  messagingSenderId: "928834764710",
  appId: "1:928834764710:web:2b2bc562d7dd6f0e33d967"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// -------- DOM references ----------
const createBtn = document.getElementById('createBtn');
const joinBtn = document.getElementById('joinBtn');
const disconnectBtn = document.getElementById('disconnectBtn');
const authBtns = document.getElementById('authBtns');
const connectedBtns = document.getElementById('connectedBtns');
const roomInfo = document.getElementById('roomInfo');
const roomCodeEl = document.getElementById('roomCode');
const usersList = document.getElementById('users');
const videoControls = document.getElementById('videoControls');
const videoUrlInput = document.getElementById('videoUrl');
const loadBtn = document.getElementById('loadBtn');

// -------- state ----------
let room = (localStorage.getItem('room') || null);
let name = (localStorage.getItem('name') || null);
let userRef = null;
let player = null;
let pending = null;
let ignore = false;

// -------- YouTube player init ----------
function onYouTubeIframeAPIReady(){
  player = new YT.Player('player', {
    width: '100%',
    height: '100%',
    playerVars: { autoplay: 1, mute: 1 },
    events: { onStateChange: onPlayerState }
  });
}

// extract id from any usual url or accept raw id
function extractVideoID(url){
  if(!url) return null;
  url = String(url).trim();
  // remove querystring for youtu.be shortlinks like youtu.be/ID?si=...
  if(url.includes('youtu.be/')){
    url = url.split('?')[0];
  }
  // try v= param anywhere
  const m1 = url.match(/[?&]v=([A-Za-z0-9_-]{11})/);
  if(m1) return m1[1];
  // youtu.be short
  const m2 = url.match(/youtu\.be\/([A-Za-z0-9_-]{11})/);
  if(m2) return m2[1];
  // embed url
  const m3 = url.match(/youtube\.com\/embed\/([A-Za-z0-9_-]{11})/);
  if(m3) return m3[1];
  // plain id
  if(/^[A-Za-z0-9_-]{11}$/.test(url)) return url;
  return null;
}

// -------- UI helpers ----------
function setConnectedUI(){
  authBtns.classList.add('hidden');
  connectedBtns.classList.remove('hidden');
  roomInfo.classList.remove('hidden');
  videoControls.classList.remove('hidden');
  roomCodeEl.textContent = room;
}

function setDisconnectedUI(){
  authBtns.classList.remove('hidden');
  connectedBtns.classList.add('hidden');
  roomInfo.classList.add('hidden');
  videoControls.classList.add('hidden');
  usersList.innerHTML = '';
}

// -------- create / join / disconnect ----------
createBtn.addEventListener('click', () => {
  const n = prompt('Tvoje jméno:');
  if(!n) return;
  name = n.trim();
  room = Math.floor(100000 + Math.random()*900000).toString();

  // create room node with initial state
  db.ref('rooms/' + room).set({
    users: {},
    state: { playing: false, time: 0, ts: Date.now() }
  }).then(() => {
    saveLocal();
    joinInternal();
    alert('Místnost vytvořena. Kód: ' + room);
  }).catch(err => {
    console.error('create room err', err);
    alert('Chyba při vytváření místnosti: ' + err.message);
  });
});

joinBtn.addEventListener('click', () => {
  const r = prompt('Zadej kód místnosti:');
  if(!r) return;
  room = String(r).trim();
  const n = prompt('Tvoje jméno:');
  if(!n) return;
  name = n.trim();

  // check existence (compatibly with SDK)
  db.ref('rooms/' + room).once('value').then(snap => {
    if(!snap.exists()){
      alert('Místnost neexistuje.');
      room = null;
      name = null;
      return;
    }
    saveLocal();
    joinInternal();
  }).catch(err => {
    console.error('join error', err);
    alert('Chyba při připojování: ' + err.message);
  });
});

disconnectBtn.addEventListener('click', disconnect);

function joinInternal(){
  // push user and save reference
  userRef = db.ref(`rooms/${room}/users`).push(name);
  // ensure onDisconnect removal
  try{
    userRef.onDisconnect().remove();
  }catch(e){
    console.warn('onDisconnect failed', e);
  }

  setConnectedUI();
  listenRoom();
}

// remove user and clear local
function disconnect(){
  if(userRef){
    userRef.remove().catch(err => console.warn('remove user error', err));
    userRef = null;
  }
  localStorage.removeItem('room');
  localStorage.removeItem('name');
  room = null;
  name = null;
  setDisconnectedUI();
  // reload to get clean state
  location.reload();
}

function saveLocal(){
  localStorage.setItem('room', room);
  localStorage.setItem('name', name);
}

// -------- room listeners ----------
function listenRoom(){
  if(!room) return;
  // users list
  db.ref(`rooms/${room}/users`).on('value', snap => {
    usersList.innerHTML = '';
    snap.forEach(u => {
      const li = document.createElement('li');
      li.textContent = u.val();
      usersList.appendChild(li);
    });
  });

  // state sync
  db.ref(`rooms/${room}/state`).on('value', snap => {
    pending = snap.val();
    // debug
    console.log('state updated', pending);
  });
}

// -------- video controls ----------
loadBtn.addEventListener('click', () => {
  if(!room){
    alert('Nejprve se připoj do místnosti.');
    return;
  }
  const raw = videoUrlInput.value || '';
  const id = extractVideoID(raw);
  if(!id){
    alert('Neplatný YouTube odkaz nebo ID (zkontroluj).');
    return;
  }
  // load via YT API - if player not ready, it will handle on ready
  if(player && typeof player.loadVideoById === 'function'){
    player.loadVideoById(id);
  }
  // save state so others can sync
  db.ref(`rooms/${room}/state`).set({
    playing: true,
    time: 0,
    ts: Date.now()
  }).catch(err => {
    console.error('state set err', err);
  });
});

// -------- YT state handling & robust sync ----------
function onPlayerState(e){
  // when newly playing and pending state exists, do sync (seek after load)
  if(e.data === YT.PlayerState.PLAYING && pending){
    ignore = true;
    try{
      const delay = (Date.now() - (pending.ts || 0)) / 1000;
      const target = (pending.time || 0) + delay;
      console.log('applying pending sync: target sec', target);
      player.seekTo(target, true);
      if(pending.playing) player.playVideo(); else player.pauseVideo();
    }catch(err){
      console.warn('seek error', err);
    }
    pending = null;
    setTimeout(()=> ignore = false, 300);
  }

  if(ignore || !room) return;

  // update DB on user actions
  if(e.data === YT.PlayerState.PLAYING || e.data === YT.PlayerState.PAUSED){
    const now = Date.now();
    const playing = e.data === YT.PlayerState.PLAYING;
    const time = (typeof player.getCurrentTime === 'function') ? player.getCurrentTime() : 0;
    db.ref(`rooms/${room}/state`).set({ playing, time, ts: now }).catch(err => {
      console.error('failed set state', err);
    });
  }
}

// -------- autorenew / rejoin after refresh if possible ----------
if(room && name){
  // try to rejoin only if room exists
  db.ref('rooms/' + room).once('value').then(snap => {
    if(snap.exists()){
      // join silently
      joinInternal();
    } else {
      console.log('stored room not found, clearing local');
      localStorage.removeItem('room');
      localStorage.removeItem('name');
      room = null; name = null;
    }
  }).catch(err => {
    console.error('check stored room err', err);
    localStorage.removeItem('room');
    localStorage.removeItem('name');
  });
}
</script>

</body>
</html>
