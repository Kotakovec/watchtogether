<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<title>Watch Together</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script src="https://www.youtube.com/iframe_api"></script>

<style>
body {
    margin:0;
    background:#0d0d0d;
    color:white;
    font-family:Arial;
    display:flex;
    height:100vh;
}
#sidebar {
    width:260px;
    background:#111;
    display:flex;
    flex-direction:column;
    padding:10px;
}
#main {
    flex:1;
    display:flex;
    flex-direction:column;
    padding:10px;
}
button,input {
    padding:8px;
    margin:4px 0;
    border:none;
    border-radius:4px;
}
button {
    background:#2563eb;
    color:white;
    cursor:pointer;
}
button.red { background:#b91c1c; }
button:hover { opacity:0.9; }
input {
    background:#222;
    color:white;
}
#users {
    margin-top:6px;
    overflow:auto;
    flex:1;
}
#player {
    flex:1;
    background:black;
}
.small { font-size:13px; color:#aaa; }
.code {
    background:#222;
    padding:6px;
    border-radius:4px;
    margin:6px 0;
    font-weight:bold;
    text-align:center;
}
.hidden { display:none; }
</style>
</head>

<body>

<div id="sidebar">

    <div id="authBtns">
        <button onclick="createRoom()">Vytvořit místnost</button>
        <button onclick="joinRoom()">Připojit se</button>
    </div>

    <div id="connectedBtns" class="hidden">
        <button class="red" onclick="disconnect()">Odpojit se</button>
    </div>

    <div id="roomInfo" class="hidden">
        <div class="small">Kód místnosti:</div>
        <div id="roomCode" class="code"></div>
    </div>

    <div class="small">Připojení lidé:</div>
    <ul id="users"></ul>

    <div id="videoControls" class="hidden" style="margin-top:auto">
        <input id="videoUrl" placeholder="YouTube odkaz">
        <button onclick="loadVideo()">Načíst video</button>
    </div>

</div>

<div id="main">
    <div id="player"></div>
</div>

<script>
// ================= FIREBASE INICIALIZACE =================
const firebaseConfig = {
  apiKey: "AIzaSyBn6sJX5f9MIIXUSBWJDEc2zsDkr5Z7O0o",
  authDomain: "watchtogether-e67a5.firebaseapp.com",
  // Zde používáme TVOU původní (evropskou) URL z prvního dotazu
  databaseURL: "https://watchtogether-e67a5-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "watchtogether-e67a5",
  storageBucket: "watchtogether-e67a5.appspot.com",
  messagingSenderId: "928834764710",
  appId: "1:928834764710:web:2b2bc562d7dd6f0e33d967"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ================= GLOBALNÍ PROMĚNNÉ A HTML PRVKY =================
let room = localStorage.getItem("room");
let name = localStorage.getItem("name");
let userRef = null;
let player;
let ignore = false; 
let videoIdToLoad = null; // Pro uložení ID videa, než se přehrávač inicializuje

// Zajištění, že se proměnné odkazují na HTML prvky
const authBtns = document.getElementById("authBtns");
const connectedBtns = document.getElementById("connectedBtns");
const roomInfo = document.getElementById("roomInfo");
const roomCode = document.getElementById("roomCode");
const users = document.getElementById("users");
const videoControls = document.getElementById("videoControls");
const videoUrl = document.getElementById("videoUrl");

// ================= YOUTUBE API =================
function onYouTubeIframeAPIReady() {
    player = new YT.Player("player", {
        width:"100%",
        height:"100%",
        playerVars:{ autoplay:1, mute:1 }, 
        events:{ 
            onStateChange:onPlayerState,
            onReady: onPlayerReady 
        }
    });
}

function onPlayerReady(e) {
    if (videoIdToLoad) {
        e.target.loadVideoById(videoIdToLoad);
        videoIdToLoad = null; 
    }
}

function extractVideoID(url){
    const m = url.match(/(?:v=|\/)([0-9A-Za-z_-]{11})/);
    return m ? m[1] : null;
}

// ================= UI FUNKCE =================
function setConnectedUI(){
    authBtns.classList.add("hidden");
    connectedBtns.classList.remove("hidden");
    roomInfo.classList.remove("hidden");
    videoControls.classList.remove("hidden");
    roomCode.textContent = room;
}

function setDisconnectedUI(){
    authBtns.classList.remove("hidden");
    connectedBtns.classList.add("hidden");
    roomInfo.classList.add("hidden");
    videoControls.classList.add("hidden");
    users.innerHTML = "";
}

// ================= MÍSTNOST LOGIKA =================
function createRoom(){
    name = prompt("Tvoje jméno:");
    if(!name) return;

    room = prompt("Zadej kód místnosti (např. 'moje-roomka123'):");
    // Ošetření prázdného kódu a nepovolených znaků
    if(!room || room.includes('.') || room.includes('#') || room.includes('$') || room.includes('/') || room.includes('[')) {
        alert("Neplatný kód místnosti. Použij pouze písmena, číslice a pomlčky.");
        return;
    }
    
    // Kontrola existence a vytvoření místnosti
    db.ref("rooms/"+room).get().then(s=>{
        if(s.exists()){
            alert("Místnost s tímto kódem už existuje. Zkus se připojit nebo zvol jiný kód.");
        } else {
            db.ref("rooms/"+room).set({
                users:{},
                state:{playing:false,time:0,ts:Date.now(),videoId:null}
            })
            .then(() => {
                saveLocal();
                joinInternal();
                alert("Místnost vytvořena! Kód: "+room);
            })
            .catch(error => {
                // Zachytí chybu s PERMISSION_DENIED
                alert("Chyba při vytváření místnosti! Zkontroluj pravidla v Firebase RTDB (musí povolit zápis pro /rooms).");
                console.error("Firebase SET chyba:", error);
            });
        }
    });
}

function joinRoom(){
    room = prompt("Kód místnosti:");
    if(!room) return;

    name = prompt("Tvoje jméno:");
    if(!name) return;

    db.ref("rooms/"+room).get().then(s=>{
        if(!s.exists()){
            alert("Místnost neexistuje");
        } else {
            saveLocal();
            joinInternal();
        }
    });
}

function joinInternal(){
    // Zápis do onDisconnect se musí provést před nastavením hodnoty
    window.addEventListener("beforeunload", () => {
        if(userRef) userRef.onDisconnect().remove();
    });
    
    // Přidání uživatele
    userRef = db.ref(`rooms/${room}/users`).push(name);
    
    // Zajištění, že se onDisconnect nastaví pro novou referenci
    userRef.onDisconnect().remove();

    setConnectedUI();
    listenRoom();
}

function disconnect(){
    if(userRef) userRef.remove();
    localStorage.clear();
    location.reload(); 
}

function saveLocal(){
    localStorage.setItem("room",room);
    localStorage.setItem("name",name);
}

// ================= SYNCHRONIZAČNÍ LOGIKA =================
function listenRoom(){
    // 1. Synchronizace uživatelů
    db.ref(`rooms/${room}/users`).on("value", snap=>{
        users.innerHTML="";
        snap.forEach(u=>{
            const li=document.createElement("li");
            li.textContent=u.val();
            users.appendChild(li);
        });
    });

    // 2. Synchronizace stavu videa
    db.ref(`rooms/${room}/state`).on("value", snap=>{
        const state = snap.val();
        if (!state || !room || ignore) return; 
        
        if (!player || player.getPlayerState() === -1) { // -1 = unstarted/nezainicializovaný
            if (state.videoId) videoIdToLoad = state.videoId;
            return;
        }

        // Zkontroluj, zda je načtené správné video
        if (state.videoId && player.getVideoData().video_id !== state.videoId) {
            ignore = true; 
            player.loadVideoById(state.videoId, state.time, state.playing ? 'play' : 'pause');
            setTimeout(() => ignore = false, 500);
            return;
        }

        // Korekce zpoždění
        const delay = (Date.now() - state.ts) / 1000;
        const targetTime = (state.time || 0) + delay;
        
        // Hranice pro skok
        if (Math.abs(player.getCurrentTime() - targetTime) > 1.0) {
            ignore = true; 
            player.seekTo(targetTime, true);
            setTimeout(() => ignore = false, 300);
        }

        // Synchronizace Play/Pause stavu
        if (state.playing && player.getPlayerState() !== YT.PlayerState.PLAYING) {
            player.playVideo();
        } else if (!state.playing && player.getPlayerState() !== YT.PlayerState.PAUSED) {
            player.pauseVideo();
        }
    });
}

function loadVideo(){
    const id = extractVideoID(videoUrl.value);
    if(!id) return alert("Neplatný YouTube odkaz");

    if (!player) {
        // Tuto cestu by nemělo být potřeba, protože se přehrávač inicializuje hned, ale pro jistotu
        alert("Přehrávač se ještě nenačetl. Zkus to za chvíli.");
        return;
    }
    
    player.loadVideoById(id);
    
    db.ref(`rooms/${room}/state`).set({
        playing: true,
        videoId: id, 
        time: 0,
        ts: Date.now()
    });
}

function onPlayerState(e){
    if(ignore || !room) return;

    if(e.data === YT.PlayerState.PLAYING || e.data === YT.PlayerState.PAUSED){
        db.ref(`rooms/${room}/state`).set({
            playing: e.data === YT.PlayerState.PLAYING,
            videoId: player.getVideoData().video_id, 
            time: player.getCurrentTime(),
            ts: Date.now()
        });
    }
}

// ================= AUTO-REJOIN =================
if(room && name){
    db.ref("rooms/"+room).get().then(s=>{
        if(s.exists()){
            joinInternal();
        } else {
            localStorage.clear();
        }
    });
}
</script>

</body>
</html>
