<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<title>Watch Together</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script src="https://www.youtube.com/iframe_api"></script>

<style>
body {
  margin:0;
  background:#0d0d0d;
  color:white;
  font-family:Arial;
  display:flex;
  height:100vh;
}
#sidebar {
  width:260px;
  background:#111;
  padding:10px;
  display:flex;
  flex-direction:column;
}
#main { flex:1; padding:10px; }
button,input {
  width:100%;
  padding:8px;
  margin:5px 0;
  border:none;
  border-radius:4px;
}
button {
  background:#2563eb;
  color:white;
}
button.red { background:#b91c1c; }
input { background:#222; color:white; }
.hidden { display:none; }
#users { flex:1; overflow:auto; margin-top:8px; }
#player { width:100%; height:100%; background:black; }
.code {
  background:#222;
  padding:6px;
  font-weight:bold;
  text-align:center;
  margin-bottom:6px;
}
</style>
</head>

<body>

<div id="sidebar">

  <div id="auth">
    <button onclick="createRoom()">Vytvořit místnost</button>
    <button onclick="joinRoom()">Připojit se</button>
  </div>

  <div id="connected" class="hidden">
    <button class="red" onclick="disconnect()">Odpojit se</button>
    <div id="roomCode" class="code"></div>
  </div>

  <div id="videoControls" class="hidden">
    <input id="videoInput" placeholder="YouTube odkaz nebo ID">
    <button onclick="loadVideo()">Načíst video</button>
  </div>

  <div>Lidi:</div>
  <ul id="users"></ul>
</div>

<div id="main">
  <div id="player"></div>
</div>

<script>
// =============== FIREBASE ===============
firebase.initializeApp({
  apiKey: "AIzaSyBn6sJX5f9MIIXUSBWJDEc2zsDkr5Z7O0o",
  authDomain: "watchtogether-e67a5.firebaseapp.com",
  databaseURL: "https://watchtogether-e67a5-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "watchtogether-e67a5"
});
const db = firebase.database();

// =============== STATE ===============
let room = localStorage.getItem("room");
let name = localStorage.getItem("name");
let userRef = null;
let player;
let ignore = false;

// =============== YT ===============
function onYouTubeIframeAPIReady(){
  player = new YT.Player("player",{ events:{onStateChange:onState}});
}

function extractID(text){
  const m = text.match(/(?:v=|\/)([0-9A-Za-z_-]{11})/);
  return m ? m[1] : text.length===11 ? text : null;
}

// =============== UI ===============
function connectedUI(){
  auth.classList.add("hidden");
  connected.classList.remove("hidden");
  videoControls.classList.remove("hidden");
  roomCode.textContent = "KÓD: " + room;
}
function disconnectedUI(){
  auth.classList.remove("hidden");
  connected.classList.add("hidden");
  videoControls.classList.add("hidden");
  users.innerHTML="";
}

// =============== ROOMS ===============
function createRoom(){
  const r = prompt("Zvol 6místný kód (čísla)");
  if(!/^\d{6}$/.test(r)) return alert("Musí to být 6 číslic");
  const n = prompt("Tvoje jméno");
  if(!n) return;

  db.ref("rooms/"+r).get().then(s=>{
    if(s.exists()) return alert("Místnost už existuje");

    db.ref("rooms/"+r).set({
      state:{playing:false,time:0},
      users:{}
    });

    room=r; name=n;
    save(); joinInternal();
  });
}

function joinRoom(){
  const r = prompt("Zadej kód");
  const n = prompt("Tvoje jméno");
  if(!r || !n) return;

  db.ref("rooms/"+r).get().then(s=>{
    if(!s.exists()) return alert("Místnost neexistuje");
    room=r; name=n;
    save(); joinInternal();
  });
}

function joinInternal(){
  userRef = db.ref("rooms/"+room+"/users").push(name);
  connectedUI();
  listen();
  window.addEventListener("beforeunload",()=>userRef.onDisconnect().remove());
}

function disconnect(){
  userRef.remove();
  localStorage.clear();
  location.reload();
}

function save(){
  localStorage.setItem("room",room);
  localStorage.setItem("name",name);
}

// =============== LISTEN ===============
function listen(){
  db.ref("rooms/"+room+"/users").on("value",s=>{
    users.innerHTML="";
    s.forEach(u=>{
      const li=document.createElement("li");
      li.textContent=u.val();
      users.appendChild(li);
    });
  });

  db.ref("rooms/"+room+"/state").on("value",s=>{
    const st=s.val();
    if(!player || !st) return;
    ignore=true;
    if(Math.abs(player.getCurrentTime()-st.time)>1)
      player.seekTo(st.time,true);
    st.playing ? player.playVideo() : player.pauseVideo();
    setTimeout(()=>ignore=false,300);
  });
}

// =============== VIDEO ===============
function loadVideo(){
  const id = extractID(videoInput.value);
  if(!id) return alert("Neplatný odkaz");
  player.loadVideoById(id);
  db.ref("rooms/"+room+"/state").set({playing:true,time:0});
}

function onState(e){
  if(ignore || !room) return;
  if(e.data===1 || e.data===2){
    db.ref("rooms/"+room+"/state").set({
      playing:e.data===1,
      time:player.getCurrentTime()
    });
  }
}

// =============== AUTO REJOIN ===============
if(room && name){
  db.ref("rooms/"+room).get().then(s=>{
    if(s.exists()) joinInternal();
    else localStorage.clear();
  });
}
</script>

</body>
</html>
