<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Watch Together</title>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script src="https://www.youtube.com/iframe_api"></script>

<style>
body{
  margin:0;
  background:#0d0d0d;
  color:white;
  font-family:Arial;
  display:flex;
  height:100vh;
}
#sidebar{
  width:220px;
  background:#111;
  border-right:2px solid #222;
  padding:10px;
}
#main{
  flex:1;
  display:flex;
  flex-direction:column;
  padding:10px;
}
input,button{
  padding:8px;
  font-size:16px;
}
#player{
  flex:1;
  margin-top:10px;
}
</style>
</head>
<body>

<div id="sidebar">
<h3>Lidi</h3>
<ul id="users"></ul>
</div>

<div id="main">
<input id="videoId" placeholder="YouTube VIDEO ID (např. mzrdbF-TwFo)">
<button onclick="setVideo()">Načíst video</button>
<div id="player"></div>
</div>

<script>
// ✅ FIREBASE
const firebaseConfig = {
  apiKey: "AIzaSyBn6sJX5f9MIIXUSBWJDEc2zsDkr5Z7O0o",
  authDomain: "watchtogether-e67a5.firebaseapp.com",
  databaseURL: "https://watchtogether-e67a5-default-rtdb.firebaseio.com",
  projectId: "watchtogether-e67a5",
  storageBucket: "watchtogether-e67a5.appspot.com",
  messagingSenderId: "928834764710",
  appId: "1:928834764710:web:2b2bc562d7dd6f0e33d967"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ✅ ROOM
const room = "room1";
const username = "User_" + Math.floor(Math.random()*1000);

// ✅ USERS
db.ref(`rooms/${room}/users`).push(username);
db.ref(`rooms/${room}/users`).on("value", snap=>{
  const ul = document.getElementById("users");
  ul.innerHTML="";
  snap.forEach(u=>{
    const li=document.createElement("li");
    li.textContent=u.val();
    ul.appendChild(li);
  });
});

// ✅ YOUTUBE PLAYER
let player;
let ignore = false;

function onYouTubeIframeAPIReady(){
  player = new YT.Player("player",{
    height:"100%",
    width:"100%",
    videoId:"",
    playerVars:{ autoplay:1 },
    events:{ onStateChange:onPlayerState }
  });
}

// ✅ PLAYER EVENTS → FIREBASE
function onPlayerState(e){
  if(ignore) return;
  if(e.data === YT.PlayerState.PLAYING){
    db.ref(`rooms/${room}/state`).set({
      playing:true,
      time:player.getCurrentTime()
    });
  }
  if(e.data === YT.PlayerState.PAUSED){
    db.ref(`rooms/${room}/state`).set({
      playing:false,
      time:player.getCurrentTime()
    });
  }
}

// ✅ FIREBASE → PLAYER
db.ref(`rooms/${room}/state`).on("value",snap=>{
  const s=snap.val();
  if(!s || !player) return;
  ignore=true;

  if(Math.abs(player.getCurrentTime()-s.time)>1){
    player.seekTo(s.time,true);
  }
  if(s.playing) player.playVideo();
  else player.pauseVideo();

  setTimeout(()=>ignore=false,300);
});

// ✅ LOAD VIDEO
function setVideo(){
  const id=document.getElementById("videoId").value.trim();
  if(!/^[a-zA-Z0-9_-]{11}$/.test(id)){
    alert("Musíš zadat VIDEO ID (11 znaků)");
    return;
  }
  db.ref(`rooms/${room}/video`).set(id);
}

db.ref(`rooms/${room}/video`).on("value",snap=>{
  const id=snap.val();
  if(id && player){
    player.loadVideoById(id);
  }
});
</script>

</body>
</html>