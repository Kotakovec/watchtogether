<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8" />
<title>Watch Together + Voice</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script src="https://www.youtube.com/iframe_api"></script>

<style>
body{margin:0;background:#0d0d0d;color:white;font-family:Arial;display:flex;height:100vh}
#sidebar{width:250px;background:#111;padding:10px;display:flex;flex-direction:column}
#users{flex:1;overflow:auto}
#main{flex:1;display:flex;flex-direction:column;padding:10px}
button,input{padding:8px;margin:4px 0}
iframe{flex:1;border:none;background:black}
.mute{background:#b00}
</style>
</head>

<body>

<div id="sidebar">
  <button onclick="createRoom()">Vytvoit m铆stnost</button>
  <button onclick="joinRoom()">Pipojit se</button>

  <h3>Lidi</h3>
  <ul id="users"></ul>

  <button id="micBtn" class="mute" onclick="toggleMic()"> Vypnuto</button>
</div>

<div id="main">
  <input id="url" placeholder="YouTube odkaz">
  <button onclick="loadVideo()">Na铆st video</button>
  <div id="player"></div>
</div>

<audio id="remoteAudio" autoplay></audio>

<script>
// ================= FIREBASE =================
const firebaseConfig = {
  apiKey: "TV女J_API_KEY",
  authDomain: "TV女J_DOMAIN",
  databaseURL: "TV女J_DB_URL",
  projectId: "TV女J_PROJECT_ID"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ================= GLOBAL =================
let room,name,player,ignore=false,pending=null;

// ================= YOUTUBE =================
function onYouTubeIframeAPIReady(){
  player = new YT.Player("player",{
    playerVars:{autoplay:1,mute:1},
    events:{onStateChange:onPlayerState}
  });
}

function extractID(u){
  const m=u.match(/(?:v=|\/)([0-9A-Za-z_-]{11})/);
  return m?m[1]:null;
}

function loadVideo(){
  const id=extractID(url.value);
  if(!id) return alert("patn媒 odkaz");
  player.loadVideoById(id);
  db.ref(`rooms/${room}/state`).set({playing:true,time:0,ts:Date.now()});
}

function onPlayerState(e){
  if(e.data===YT.PlayerState.PLAYING && pending){
    ignore=true;
    const d=(Date.now()-pending.ts)/1000;
    player.seekTo(pending.time+d,true);
    pending.playing?player.playVideo():player.pauseVideo();
    pending=null;
    setTimeout(()=>ignore=false,300);
  }
  if(ignore) return;
  if([1,2].includes(e.data)){
    db.ref(`rooms/${room}/state`).set({
      playing:e.data===1,
      time:player.getCurrentTime(),
      ts:Date.now()
    });
  }
}

// ================= ROOM =================
function createRoom(){
  name=prompt("Jm茅no:");
  room=Math.floor(100000+Math.random()*900000).toString();
  db.ref("rooms/"+room).set({users:{},state:{}});
  join();
  alert("K贸d: "+room);
}
function joinRoom(){
  room=prompt("K贸d:");
  name=prompt("Jm茅no:");
  db.ref("rooms/"+room).get().then(s=>{
    if(!s.exists()) alert("Neexistuje");
    else join();
  });
}
function join(){
  db.ref(`rooms/${room}/users`).push(name);
  listen();
}

// ================= LISTEN =================
function listen(){
  db.ref(`rooms/${room}/users`).on("value",s=>{
    users.innerHTML="";
    s.forEach(u=>{
      const li=document.createElement("li");
      li.textContent=u.val();
      users.appendChild(li);
    });
  });
  db.ref(`rooms/${room}/state`).on("value",s=>pending=s.val());
  setupVoice();
}

// ================= VOICE CHAT =================
let pc,stream,muted=true;

async function setupVoice(){
  stream = await navigator.mediaDevices.getUserMedia({audio:true});
  stream.getTracks()[0].enabled=false;

  pc = new RTCPeerConnection({
    iceServers:[{urls:"stun:stun.l.google.com:19302"}]
  });

  stream.getTracks().forEach(t=>pc.addTrack(t,stream));

  pc.ontrack=e=>remoteAudio.srcObject=e.streams[0];
  pc.onicecandidate=e=>{
    if(e.candidate)
      db.ref(`rooms/${room}/ice`).push(JSON.stringify(e.candidate));
  };

  const offer=await pc.createOffer();
  await pc.setLocalDescription(offer);
  db.ref(`rooms/${room}/offer`).set(JSON.stringify(offer));

  db.ref(`rooms/${room}/offer`).on("value", async s=>{
    if(s.val() && !pc.remoteDescription){
      await pc.setRemoteDescription(JSON.parse(s.val()));
    }
  });

  db.ref(`rooms/${room}/answer`).on("value", async s=>{
    if(s.val()){
      await pc.setRemoteDescription(JSON.parse(s.val()));
    }
  });

  db.ref(`rooms/${room}/ice`).on("child_added", s=>{
    pc.addIceCandidate(JSON.parse(s.val()));
  });

  pc.onnegotiationneeded=async ()=>{
    const answer=await pc.createAnswer();
    await pc.setLocalDescription(answer);
    db.ref(`rooms/${room}/answer`).set(JSON.stringify(answer));
  };
}

function toggleMic(){
  muted=!muted;
  stream.getTracks()[0].enabled=!muted;
  micBtn.textContent=muted?" Vypnuto":" Zapnuto";
  micBtn.classList.toggle("mute",muted);
}
</script>

</body>
</html>
