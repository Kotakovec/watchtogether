<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Watch Together – Firebase</title>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script src="https://www.youtube.com/iframe_api"></script>
<style>
  body { margin: 0; font-family: Arial; background: #0d0d0d; color: white; display: flex; height: 100vh; }
  #sidebar { width: 250px; min-width: 150px; max-width: 400px; background: #111; border-right: 2px solid #222; padding: 10px; box-sizing: border-box; overflow-y: auto; resize: horizontal; }
  #sidebar h2 { margin-top: 10px; margin-bottom: 5px; }
  #sidebar ul { padding-left: 0; list-style: none; }
  #sidebar ul li { margin-bottom: 5px; padding: 5px; background: rgba(255,255,255,0.05); border-radius: 4px; }
  #main { flex: 1; display: flex; flex-direction: column; padding: 10px; box-sizing: border-box; }
  #videoUrl { padding: 8px; margin-bottom: 10px; border-radius: 5px; border: 1px solid #444; background: #222; color: white; width: 100%; box-sizing: border-box; }
  #loadVideo { padding: 8px 12px; margin-bottom: 10px; border: none; border-radius: 5px; background: #28a745; color: white; cursor: pointer; }
  #player { flex: 1; width: 100%; border: none; border-radius: 8px; }
</style>
</head>
<body>

<div id="sidebar">
  <h2>Lidi</h2>
  <ul id="usersList"></ul>
</div>

<div id="main">
  <input id="videoUrl" type="text" placeholder="Vlož YouTube video nebo playlist URL...">
  <button id="loadVideo">Načíst Video / Playlist</button>
  <iframe id="player" src="" allow="autoplay"></iframe>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyBn6sJX5f9MIIXUSBWJDEc2zsDkr5Z7O0o",
  authDomain: "watchtogether-e67a5.firebaseapp.com",
  databaseURL: "https://watchtogether-e67a5-default-rtdb.firebaseio.com",
  projectId: "watchtogether-e67a5",
  storageBucket: "watchtogether-e67a5.appspot.com",
  messagingSenderId: "928834764710",
  appId: "1:928834764710:web:2b2bc562d7dd6f0e33d967",
  measurementId: "G-CN7C9VT3GG"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let roomCode = null;
let username = null;
let player;

function onYouTubeIframeAPIReady() {
  player = new YT.Player("player", { events: { onStateChange: syncState } });
}

let lastUpdate = 0;
function syncState(event) {
  if (!roomCode) return;
  const now = Date.now();
  if (now - lastUpdate < 500) return;
  lastUpdate = now;

  if (event.data === YT.PlayerState.PLAYING) {
    db.ref(`rooms/${roomCode}/state`).update({ playing: true, time: player.getCurrentTime() });
  }
  if (event.data === YT.PlayerState.PAUSED) {
    db.ref(`rooms/${roomCode}/state`).update({ playing: false, time: player.getCurrentTime() });
  }
}

function joinRoomPrompt() {
  roomCode = prompt("Zadej 6místný kód místnosti:");
  if (!roomCode || !/^[0-9]{6}$/.test(roomCode)) {
    alert("Kód musí být 6 číslic!");
    return joinRoomPrompt();
  }

  db.ref(`rooms/${roomCode}`).get().then(snapshot => {
    if (!snapshot.exists()) {
      const create = confirm("Místnost neexistuje. Chceš ji vytvořit?");
      if (!create) return joinRoomPrompt();
      username = prompt("Zadej svoje jméno:");
      db.ref(`rooms/${roomCode}`).set({
        users: { [Date.now()]: username },
        state: { playing: false, time: 0, currentVideo: null, playlist: [] }
      });
      listenRoom();
      alert(`Místnost vytvořena! Tvůj kód: ${roomCode}`);
    } else {
      username = prompt("Zadej svoje jméno:");
      db.ref(`rooms/${roomCode}/users`).push(username);
      listenRoom();
    }
  });
}

function listenRoom() {
  db.ref(`rooms/${roomCode}/users`).on("value", snap => {
    const list = document.getElementById("usersList");
    list.innerHTML = "";
    snap.forEach(u => { const li = document.createElement("li"); li.textContent = u.val(); list.appendChild(li); });
  });

  db.ref(`rooms/${roomCode}/state`).on("value", s => {
    const st = s.val(); if (!st) return;

    // Synchronizace videa nebo playlistu
    if (st.currentVideo) {
      if (Math.abs(player.getCurrentTime() - st.time) > 1) player.seekTo(st.time, true);
      if (st.playing) player.playVideo(); else player.pauseVideo();
    }
    // Pokud je playlist
    if (st.playlist && st.playlist.length > 0) {
      player.loadPlaylist({ list: st.playlist, listType: 'playlist', index: 0 });
    }
  });
}

function getYouTubeIDorPlaylist(url) {
  url = url.trim();
  const vMatch = url.match(/[?&]v=([a-zA-Z0-9_-]{11})/);
  if (vMatch) return { type: 'video', id: vMatch[1] };
  const listMatch = url.match(/[?&]list=([a-zA-Z0-9_-]+)/);
  if (listMatch) return { type: 'playlist', id: listMatch[1] };
  const shortMatch = url.match(/youtu\.be\/([a-zA-Z0-9_-]{11})/);
  if (shortMatch) return { type: 'video', id: shortMatch[1] };
  return null;
}

document.getElementById("loadVideo").onclick = () => {
  const url = document.getElementById("videoUrl").value;
  const res = getYouTubeIDorPlaylist(url);
  if (!res) return alert("URL není validní.");
  
  if (res.type === 'video') {
    db.ref(`rooms/${roomCode}/state`).update({ currentVideo: res.id, playlist: [], playing: true, time: 0 });
  }
  if (res.type === 'playlist') {
    db.ref(`rooms/${roomCode}/state`).update({ currentVideo: null, playlist: [res.id], playing: true, time: 0 });
  }
};

window.onload = joinRoomPrompt;
</script>
</body>
</html>
