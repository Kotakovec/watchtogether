<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <title>Watch Together - Jakub</title>
    
    <style>
        /* CSS STYLY PRO VZHLED */
        body {
            background-color: #1a1a1a;
            color: #f0f0f0;
            font-family: sans-serif;
            margin: 0;
            overflow: hidden; 
            height: 100vh;
        }

        .container {
            display: flex;
            height: 100vh;
            width: 100vw;
        }

        /* --- Lev√Ω Sidebar (Ovl√°d√°n√≠ a Seznam) --- */
        .left-sidebar {
            width: 250px;
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            background-color: #2a2a2a;
        }

        .controls-panel {
            padding-bottom: 20px;
            border-bottom: 1px solid #333;
        }

        .video-loader {
            margin-top: 15px;
        }

        .yellow-input {
            width: calc(100% - 12px);
            padding: 10px 5px;
            margin-bottom: 5px;
            background-color: #333;
            color: #f0f0f0;
            border: 1px solid #555;
            border-radius: 4px;
        }

        .yellow-btn {
            background-color: #ffc107; /* ≈Ωlut√° */
            color: #333;
            width: 100%;
            padding: 10px;
            border: none;
            cursor: pointer;
            font-weight: bold;
            border-radius: 4px;
        }

        .user-list-section {
            flex-grow: 1;
            padding-top: 10px;
        }

        #active-users {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        #active-users li {
            padding: 8px 0;
            font-size: 0.95em;
            border-bottom: 1px dotted #333;
        }
        
        #active-users li:last-child {
            border-bottom: none;
        }

        .active-user {
            color: #ffc107; 
            font-weight: bold;
        }

        /* --- Video Sekce --- */
        .video-section {
            flex-grow: 1;
            border: 4px solid red; /* ƒåerven√Ω r√°meƒçek */
            background-color: black;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #youtube-player {
            width: 100%; 
            height: 100%;
        }
    </style>

</head>
<body>

    <main class="container">
        
        <aside class="left-sidebar">
            
            <div class="controls-panel">
                
                <div class="video-loader">
                    <input type="text" id="video-url" placeholder="Sem vlo≈æ YouTube URL" class="yellow-input">
                    <button id="load-video-btn" class="yellow-btn">‚ñ∂Ô∏è NAƒå√çST & SYNCHRONIZOVAT</button>
                </div>
            </div>
            
            <div class="user-list-section">
                <h2>Div√°ci</h2>
                <ul id="active-users">
                    <li class="active-user">üë§ Kuba (Ty)</li>
                    <li>üë§ Div√°k 2</li>
                    <li>üë§ Div√°k 1</li>
                </ul>
            </div>
        </aside>

        <section class="video-section">
            <div id="youtube-player">
                </div>
        </section>

    </main>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.youtube.com/iframe_api"></script>

    <script>
        // --- JAVASCRIPT LOGIKA ---

        // A. Konfigurace Firebase (TOTO NAHRAƒé SV√ùMI √öDAJI!)
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            databaseURL: "YOUR_DATABASE_URL",
            projectId: "YOUR_PROJECT_ID",
            // ... dal≈°√≠
        };
        firebase.initializeApp(firebaseConfig);

        // Odkaz na datab√°zi pro konkr√©tn√≠ m√≠stnost
        const roomRef = firebase.database().ref('room1'); 
        let player; 

        // --- 1. Naƒçten√≠ P≈ôehr√°vaƒçe a Pomocn√© funkce ---

        // Funkce, kterou zavol√° YouTube API, kdy≈æ se naƒçte
        function onYouTubeIframeAPIReady() {
            player = new YT.Player('youtube-player', {
                height: '100%',
                width: '100%',
                videoId: '', // Start bez videa
                events: {
                    'onReady': onPlayerReady,
                    'onStateChange': onPlayerStateChange
                }
            });
        }

        function onPlayerReady(event) {
            console.log("P≈ôehr√°vaƒç p≈ôipraven.");
            setupVideoLoader();
            setupFirebaseListeners();
        }

        // Z√≠sk√°n√≠ YouTube ID z r≈Øzn√Ωch form√°t≈Ø URL
        function getYouTubeId(url) {
            // Regul√°rn√≠ v√Ωraz pro r≈Øzn√© form√°ty YT URL (vƒç. zkr√°cen√© youtu.be)
            const regex = /(?:youtube\.com\/(?:[^\/]+\/.+\/|\w\/\w+\?v=)|youtu\.be\/|youtube\.com\/embed\/|youtube\.com\/v\/|youtube\.com\/watch\?v=)([^&]+)/;
            const match = url.match(regex);
            return (match && match[1].length === 11) ? match[1] : null;
        }

        // --- 2. Naƒç√≠t√°n√≠ Videa z Tlaƒç√≠tka ---

        function setupVideoLoader() {
            document.getElementById('load-video-btn').addEventListener('click', () => {
                const url = document.getElementById('video-url').value;
                const videoId = getYouTubeId(url);

                if (videoId) {
                    // Po≈°le ID a nov√Ω stav (PLAYING od ƒçasu 0) do Firebase
                    roomRef.update({
                        videoID: videoId,
                        state: 'playing', 
                        currentTime: 0,
                        lastUpdated: firebase.database.ServerValue.TIMESTAMP
                    }).then(() => {
                        console.log(`Nov√© video ${videoId} odesl√°no k synchronizaci.`);
                        document.getElementById('video-url').value = ''; 
                    });
                } else {
                    alert('Chyba: Neplatn√Ω YouTube odkaz. Zkus zkop√≠rovat celou URL.');
                }
            });
        }

        // --- 3. Synchronizace Stav≈Ø ---

        // YT -> Firebase: Reakce na akci u≈æivatele
        function onPlayerStateChange(event) {
            if (player.isSyncing) return; // Zabra≈àuje zpƒõtn√©mu z√°pisu p≈ôi synchronizaci
            
            const playerState = event.data;
            const currentTime = player.getCurrentTime();

            if (playerState === YT.PlayerState.PLAYING) {
                roomRef.update({
                    state: 'playing',
                    currentTime: currentTime,
                    lastUpdated: firebase.database.ServerValue.TIMESTAMP
                });

            } else if (playerState === YT.PlayerState.PAUSED || playerState === YT.PlayerState.BUFFERING) {
                roomRef.update({
                    state: 'paused',
                    currentTime: currentTime,
                    lastUpdated: firebase.database.ServerValue.TIMESTAMP
                });
            }
        }

        // Firebase -> YT: Poslouch√°n√≠ zmƒõn v datab√°zi
        function setupFirebaseListeners() {
            roomRef.on('value', (snapshot) => {
                const data = snapshot.val();
                if (!data || !player || !player.getCurrentTime) return;

                const { videoID, state, currentTime, lastUpdated } = data;
                
                // 1. Zmƒõna Videa: Naƒçte video, pokud se v DB zmƒõnilo ID
                const currentVideoId = player.getVideoData() ? player.getVideoData().video_id : null;
                if (currentVideoId !== videoID && videoID) {
                     player.loadVideoById(videoID);
                     console.log(`Synchronizace: Naƒç√≠t√°m nov√© video: ${videoID}`);
                     return; 
                }

                // 2. Zmƒõna Stav (Play/Pause/Seek)
                
                player.isSyncing = true; // Zapneme ochranu proti zpƒõtn√©mu z√°pisu
                const localState = player.getPlayerState();
                
                if (state === 'playing' && localState !== YT.PlayerState.PLAYING) {
                    // V√Ωpoƒçet ƒçasu s korekc√≠ zpo≈ædƒõn√≠ s√≠tƒõ
                    const timeDiff = (Date.now() - lastUpdated) / 1000;
                    const syncTime = currentTime + timeDiff + 0.5; 
                    
                    player.seekTo(syncTime, true); 
                    player.playVideo();
                    console.log(`Synchronizace: P≈ôehr√°v√°m od ƒçasu ${syncTime.toFixed(1)}s`);
                
                } else if (state === 'paused' && localState !== YT.PlayerState.PAUSED && localState !== YT.PlayerState.ENDED) {
                    
                    // P≈ôejde na p≈ôesn√Ω ƒças a zastav√≠
                    player.seekTo(currentTime, true); 
                    player.pauseVideo();
                    console.log(`Synchronizace: Pozastavuji na ƒçase ${currentTime.toFixed(1)}s`);
                }
                
                // Uvoln√≠me ochranu po kr√°tk√©m zpo≈ædƒõn√≠, aby mohl u≈æivatel zase ovl√°dat
                setTimeout(() => { player.isSyncing = false; }, 200); 

                // Zde bys mohl p≈ôidat aktualizaci seznamu u≈æivatel≈Ø
            });
        }
    </script>
</body>
</html>
