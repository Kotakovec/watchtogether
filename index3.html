<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <title>Watch Together - Jakub</title>
    
    <style>
        /* CSS STYLY PRO VZHLED */
        body {
            background-color: #1a1a1a;
            color: #f0f0f0;
            font-family: sans-serif;
            margin: 0;
            overflow: hidden; /* Zabr√°n√≠ scrollov√°n√≠ */
            height: 100vh;
        }

        .container {
            display: flex;
            height: 100vh;
            width: 100vw;
        }

        /* --- Lev√Ω Sidebar --- */
        .left-sidebar {
            width: 250px;
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            background-color: #2a2a2a;
        }

        .controls-panel {
            padding-bottom: 20px;
            border-bottom: 1px solid #333;
        }

        .controls-panel button {
            margin-bottom: 5px;
            width: 100%;
            padding: 10px;
            border: none;
            cursor: pointer;
            font-weight: bold;
            border-radius: 4px;
        }

        .blue-btn {
            background-color: #4a7dff; /* Modr√° */
            color: white;
        }

        .yellow-btn {
            background-color: #ffc107; /* ≈Ωlut√° */
            color: #333;
        }

        .video-loader {
            margin-top: 15px;
        }

        .yellow-input {
            width: calc(100% - 12px);
            padding: 10px 5px;
            margin-bottom: 5px;
            background-color: #333;
            color: #f0f0f0;
            border: 1px solid #555;
            border-radius: 4px;
        }

        .user-list-section {
            flex-grow: 1;
            padding-top: 10px;
        }

        #active-users {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        #active-users li {
            padding: 8px 0;
            font-size: 0.95em;
            border-bottom: 1px dotted #333;
        }
        
        #active-users li:last-child {
            border-bottom: none;
        }

        .active-user {
            color: #ffc107; /* ≈Ωlutƒõ oznaƒçen√Ω aktu√°ln√≠ u≈æivatel */
            font-weight: bold;
        }

        /* --- Video Sekce --- */
        .video-section {
            flex-grow: 1;
            border: 4px solid red; /* ƒåerven√Ω r√°meƒçek */
            background-color: black;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #youtube-player {
            width: 100%; 
            height: 100%;
        }
    </style>

</head>
<body>

    <main class="container">
        
        <aside class="left-sidebar">
            
            <div class="controls-panel">
                <button id="mic-on" class="control-btn blue-btn">üéôÔ∏è MIC ON</button>
                <button id="hear-on" class="control-btn blue-btn">üéß HEAR ON</button>
                
                <div class="video-loader">
                    <input type="text" id="video-url" placeholder="YT Link" class="yellow-input">
                    <button id="load-video-btn" class="control-btn yellow-btn">‚ñ∂Ô∏è PLAY/NAƒå√çST</button>
                </div>
            </div>
            
            <div class="user-list-section">
                <h2>Div√°ci</h2>
                <ul id="active-users">
                    <li>üë§ Testovac√≠ U≈æivatel 5</li>
                    <li>üë§ Testovac√≠ U≈æivatel 4</li>
                    <li class="active-user">üë§ Jakub (Ty)</li>
                    <li>üë§ Testovac√≠ U≈æivatel 1</li>
                </ul>
            </div>
        </aside>

        <section class="video-section">
            <div id="youtube-player">
                </div>
        </section>

    </main>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.youtube.com/iframe_api"></script>

    <script>
        // --- JAVASCRIPT LOGIKA ---

        // A. Konfigurace Firebase (TOTO NAHRAƒé SV√ùMI √öDAJI!)
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            databaseURL: "YOUR_DATABASE_URL",
            projectId: "YOUR_PROJECT_ID",
            // ... dal≈°√≠
        };
        // Inicializace Firebase
        firebase.initializeApp(firebaseConfig);

        // Odkaz na datab√°zi pro konkr√©tn√≠ m√≠stnost (v≈ædy pou≈æ√≠v√°me 'room1')
        const roomRef = firebase.database().ref('room1'); 

        let player; // Glob√°ln√≠ promƒõnn√° pro YouTube p≈ôehr√°vaƒç

        // --- 1. Inicializace P≈ôehr√°vaƒçe ---

        // Funkce, kterou zavol√° YouTube API, kdy≈æ se naƒçte
        function onYouTubeIframeAPIReady() {
            player = new YT.Player('youtube-player', {
                height: '100%',
                width: '100%',
                videoId: 'dQw4w9WgXcQ', // Defaultn√≠ video ID (Rick Astley)
                events: {
                    'onReady': onPlayerReady,
                    'onStateChange': onPlayerStateChange
                }
            });
        }

        function onPlayerReady(event) {
            console.log("P≈ôehr√°vaƒç p≈ôipraven. Poslouch√°m Firebase.");
            setupVideoLoader();
            setupFirebaseListeners();
        }

        // --- 2. Naƒç√≠t√°n√≠ Videa ---

        // Z√≠sk√°n√≠ YouTube ID z r≈Øzn√Ωch form√°t≈Ø URL
        function getYouTubeId(url) {
            const regex = /(?:youtube\.com\/(?:[^\/]+\/.+\/|\w\/\w+\?v=)|youtu\.be\/|youtube\.com\/embed\/|youtube\.com\/v\/|youtube\.com\/watch\?v=)([^&]+)/;
            const match = url.match(regex);
            return (match && match[1]) ? match[1] : null;
        }

        function setupVideoLoader() {
            document.getElementById('load-video-btn').addEventListener('click', () => {
                const url = document.getElementById('video-url').value;
                const videoId = getYouTubeId(url);

                if (videoId) {
                    // Ode≈°le nov√© ID do Firebase, ƒç√≠m≈æ se video zmƒõn√≠ v≈°em
                    roomRef.update({
                        videoID: videoId,
                        state: 'playing', // Zaƒçne se p≈ôehr√°vat hned po naƒçten√≠
                        currentTime: 0,
                        lastUpdated: firebase.database.ServerValue.TIMESTAMP
                    });
                    document.getElementById('video-url').value = ''; 
                } else {
                    alert('Chyba: Neplatn√Ω YouTube odkaz.');
                }
            });
        }

        // --- 3. Synchronizace Stav≈Ø (J√°dro funkƒçnosti) ---

        // YT -> Firebase: Reakce na akci u≈æivatele
        function onPlayerStateChange(event) {
            // Zabra≈àuje zpƒõtn√©mu z√°pisu, pokud je stav mƒõnƒõn z DB (p≈ôi synchronizaci)
            if (player.isSyncing) return; 

            if (event.data == YT.PlayerState.PLAYING) {
                roomRef.update({
                    state: 'playing',
                    currentTime: player.getCurrentTime(),
                    lastUpdated: firebase.database.ServerValue.TIMESTAMP
                });

            } else if (event.data == YT.PlayerState.PAUSED || event.data == YT.PlayerState.BUFFERING) {
                roomRef.update({
                    state: 'paused',
                    currentTime: player.getCurrentTime(),
                    lastUpdated: firebase.database.ServerValue.TIMESTAMP
                });
            }
        }

        // Firebase -> YT: Poslouch√°n√≠ zmƒõn v datab√°zi a synchronizace p≈ôehr√°vaƒçe
        function setupFirebaseListeners() {
            roomRef.on('value', (snapshot) => {
                const data = snapshot.val();
                if (!data || !player || !player.getCurrentTime) return;

                const { videoID, state, currentTime, lastUpdated } = data;
                
                // 1. Zmƒõna Videa
                const currentVideoId = player.getVideoData().video_id;
                if (currentVideoId !== videoID) {
                     player.loadVideoById(videoID);
                     console.log(`Synchronizace: Naƒç√≠t√°m nov√© video: ${videoID}`);
                     return; 
                }

                // 2. Zmƒõna Stav (Play/Pause/Seek)
                
                // Nastav√≠me ochranu, aby se stav neodeslal zpƒõt do DB
                player.isSyncing = true; 
                const localState = player.getPlayerState();
                
                if (state === 'playing' && localState !== YT.PlayerState.PLAYING) {
                    // V√Ωpoƒçet ƒçasu s korekc√≠ zpo≈ædƒõn√≠ s√≠tƒõ
                    const timeDiff = (Date.now() - lastUpdated) / 1000;
                    const syncTime = currentTime + timeDiff + 0.5; // +0.5s pro korekci bufferu
                    
                    player.seekTo(syncTime, true); 
                    player.playVideo();
                    console.log(`Synchronizace: P≈ôehr√°v√°m od ƒçasu ${syncTime.toFixed(1)}`);
                
                } else if (state === 'paused' && localState !== YT.PlayerState.PAUSED && localState !== YT.PlayerState.ENDED) {
                    
                    // P≈ôejde na p≈ôesn√Ω ƒças a zastav√≠
                    player.seekTo(currentTime, true); 
                    player.pauseVideo();
                    console.log(`Synchronizace: Pozastavuji na ƒçase ${currentTime.toFixed(1)}`);
                }
                
                // Uvoln√≠me ochranu po kr√°tk√©m zpo≈ædƒõn√≠
                setTimeout(() => { player.isSyncing = false; }, 200); 

                // Zde bys mohl p≈ôidat logiku pro aktualizaci seznamu u≈æivatel≈Ø
                // updateUserList(data.users);
            });
        }
    </script>
</body>
</html>
