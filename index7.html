<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<title>Watch Together</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script src="https://www.youtube.com/iframe_api"></script>

<style>
/* CSS STYLY */
html {
Â  height: 100%; 
}
body {
Â  margin:0;
Â  background:#0d0d0d;
Â  color:white;
Â  font-family:Arial;
Â  display:flex;
Â  height:100vh;
}
#sidebar {
Â  width:260px;
Â  background:#111;
Â  display:flex;
Â  flex-direction:column;
Â  padding:10px;
    position: relative;
    z-index: 10; 
}
#main {
Â  flex:1;
Â  display:flex;
Â  flex-direction:column;
Â  /* ÄŒervenÃ½ rÃ¡meÄek */
Â  border: 4px solid red; 
Â  height: 100%; 
Â  min-height: 0;
}
button,input {
Â  padding:8px;
Â  margin:4px 0;
Â  border:none;
Â  border-radius:4px;
}
/* NovÃ© styly pro tlaÄÃ­tka vlevo nahoÅ™e */
.control-button {
    background:#337ab7; /* ModrÃ¡ barva */
    color:white;
    font-weight: bold;
    cursor:pointer;
    width: 100px; /* PevnÃ¡ Å¡Ã­Å™ka jako na obrÃ¡zku */
    margin: 5px 0;
    padding: 8px 12px;
    text-align: left; /* Text zarovnanÃ½ vlevo */
}
.control-button.yellow {
    background: #ffc107; /* Å½lutÃ¡ pro "PLAY" */
    color: #333;
}
.control-button:hover { opacity:0.9; }

input {
Â  background:#222;
Â  color:white;
}
#users-container {
    margin-top: auto; /* Posune seznam uÅ¾ivatelÅ¯ ÃºplnÄ› dolÅ¯ */
    padding-top: 10px;
    border-top: 1px solid #333;
}
#users {
Â  margin-top:6px;
Â  overflow:auto;
Â  padding: 0;
Â  list-style: none;
}
#users li {
Â  padding: 4px 0;
Â  border-bottom: 1px dotted #333;
}
#player {
Â  flex:1;
Â  background:black;
Â  width: 100%;
Â  height: 100%;
}
.small { font-size:13px; color:#aaa; }

/* TÅ˜ÃDA PRO SKRÃVÃNÃ DIALOGU */
.hidden { 
    display: none !important; 
} 

/* Styly pro dialogovÃ© okno */
.dialog-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
}
.dialog-box {
    background: #222;
    padding: 20px;
    border-radius: 8px;
    text-align: center;
}
.dialog-box input {
    margin-bottom: 10px;
}
.dialog-box label {
    font-size: 14px;
    display: block;
    margin-top: 10px;
}
</style>
</head>

<body>

<div id="sidebar">

Â  <div id="topControls" style="padding-bottom: 20px;">
    
    <button class="control-button">ğŸ”Š MIC ON</button>
    <button class="control-button">ğŸ§ HEAR ON</button>

    <div id="videoControls" style="margin-top: 20px; margin-bottom: 5px;">
        <div class="small">VloÅ¾it YouTube odkaz:</div>
        <input id="videoUrl" placeholder="YouTube odkaz" autocomplete="off">
        <button id="loadVideoBtn" class="control-button yellow" onclick="loadVideo()" style="width: 100%;"> â–¶ï¸ PLAY</button>
    </div>
    
    <div style="margin-top: 10px; font-size: 14px; display: flex; align-items: center;">
        <input type="checkbox" id="allowControl" style="margin: 0 5px 0 0;">
        <label for="allowControl" style="margin: 0; padding: 0;">Povolit ostatnÃ­m ovlÃ¡dat video</label>
    </div>
    
  </div>
  Â  
  <div id="users-container">
    <div class="small">PÅ™ipojenÃ­ lidÃ©:</div>
    <ul id="users">
      </ul>
  </div>

</div>

<div id="main">
Â  Â  <div id="player"></div>
</div>

<div id="nameDialog" class="dialog-overlay hidden">
    <div class="dialog-box">
        <h2>Ahoj!</h2>
        <input type="text" id="inputName" placeholder="Zadej prosÃ­m svÃ© jmÃ©no" autocomplete="off">
        <label>
            <input type="checkbox" id="rememberName"> Zapamatovat jmÃ©no
        </label>
        <button onclick="submitName()">Potvrdit</button>
    </div>
</div>

<script>
// ================= FIREBASE KONFIGURACE =================
const firebaseConfig = {
  apiKey: "AIzaSyBn6sJX5f9MIIXUSBWJDEc2zsDkr5Z7O0o",
  authDomain: "watchtogether-e67a5.firebaseapp.com",
  databaseURL: "https://watchtogether-e67a5-default-rtdb.firebaseio.com",
  projectId: "watchtogether-e67a5",
  storageBucket: "watchtogether-e67a5.firebasestorage.app",
  messagingSenderId: "928834764710",
  appId: "1:928834764710:web:2b2bc562d7dd6f0e33d967",
  measurementId: "G-CN7C9VT3GG"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ================= GLOBAL & SETUP =================
const room = "room123"; 
let name;
let userRef = null;
let player;
let isApplyingState = false; 
let lastVideoID = null; 
let pendingState = null;
let isHost = false; 

window.onload = function() {
    if (localStorage.getItem("name") === "AnonymnÃ­ divÃ¡k") {
        localStorage.removeItem("name");
    }
    
Â  Â  name = localStorage.getItem("name");

Â  Â  if (name) {
Â  Â  Â  Â  joinInternal();
Â  Â  } else {
Â  Â  Â  Â  document.getElementById('nameDialog').classList.remove('hidden');
Â  Â  }
};

function submitName() {
    const inputField = document.getElementById('inputName');
    const rememberCheckbox = document.getElementById('rememberName');
    
    let tempName = inputField.value.trim();
    
    if (tempName === "") {
        alert("ProsÃ­m zadej svÃ© jmÃ©no, nemÅ¯Å¾e bÃ½t prÃ¡zdnÃ©.");
        return;
    }
    
    name = tempName;

    db.ref(`rooms/${room}/users`).once('value').then(snapshot => {
        let nameExists = false;
        snapshot.forEach(user => {
            if (user.val() === name) {
                nameExists = true;
            }
        });

        if (nameExists) {
            alert(`JmÃ©no '${name}' uÅ¾ je v mÃ­stnosti! Zkus prosÃ­m jinÃ©.`);
        } else {
            if (rememberCheckbox.checked) {
                localStorage.setItem("name", name);
            } else {
                localStorage.removeItem("name");
            }
            
            document.getElementById('nameDialog').classList.add('hidden');
            joinInternal();
        }
    });
}

// ================= YOUTUBE API =================
function onYouTubeIframeAPIReady() {
Â  player = new YT.Player("player", {
Â  Â  width:"100%",
Â  Â  height:"100%",
Â  Â  events:{ onStateChange:onPlayerState, onReady: onPlayerReady } 
Â  });
}

function onPlayerReady(e) {
Â  db.ref(`rooms/${room}/state`).once('value').then(snap => {
Â  Â  if (snap.exists() && snap.val().videoID) {
Â  Â  Â  applyState(snap.val());
Â  Â  }
Â  });
}

function extractVideoID(url){
Â  const m = url.match(/(?:v=|\/)([0-9A-Za-z_-]{11})/);
Â  return m ? m[1] : null;
}

// ================= OVLÃDÃNÃ A SETUP =================

function setupControls() {
    const controlSwitch = document.getElementById('allowControl');
    const roomControlRef = db.ref(`rooms/${room}/controlsEnabled`);
    const urlInput = document.getElementById('videoUrl');
    const loadBtn = document.getElementById('loadVideoBtn');

    if (isHost) {
        controlSwitch.disabled = false;
        
        roomControlRef.once('value').then(snap => {
            const enabled = snap.val() === true;
            controlSwitch.checked = enabled;
        });

        controlSwitch.addEventListener('change', () => {
            roomControlRef.set(controlSwitch.checked);
        });
    } else {
        controlSwitch.disabled = true;
    }
    
    roomControlRef.on('value', snap => {
        const enabled = snap.val() === true;
        
        if (!isHost) {
            controlSwitch.checked = enabled; 
        }
        
        const isSelfControlling = isHost || enabled;
        urlInput.disabled = !isSelfControlling;
        loadBtn.disabled = !isSelfControlling;
    });
}


function joinInternal(){
Â  userRef = db.ref(`rooms/${room}/users`).push(name);
Â  userRef.onDisconnect().remove(); 
Â  
Â  db.ref("rooms/"+room).get().then(s=>{
Â  Â  if(!s.exists()){
Â  Â  Â  isHost = true;
Â  Â  Â  db.ref("rooms/"+room).set({
Â  Â  Â  Â  users:{ [userRef.key]: name },
Â  Â  Â  Â  state:{playing:false, time:0, ts:Date.now(), videoID: "dQw4w9WgXcQ"},
          controlsEnabled: false 
Â  Â  Â  });
Â  Â  } else {
      isHost = false; 
    }
    
    setupControls();
Â  });
Â  
Â  listenRoom();
}

window.addEventListener("beforeunload", () => {
Â  if(userRef) userRef.remove();
});

// ================= LISTEN & APPLY (Synchronizace) =================

function applyState(data) {
Â  if(!data || !player || !player.getCurrentTime) return;

Â  isApplyingState = true;
Â  const { playing, time, ts, videoID } = data;
Â  const localState = player.getPlayerState();
Â  const videoChanged = lastVideoID !== videoID;

Â  // 1. NaÄtenÃ­/ZmÄ›na Videa
Â  if (videoChanged && videoID) {
Â  Â  lastVideoID = videoID;
Â  Â  pendingState = { playing, time, ts, videoID }; 
Â  Â  player.loadVideoById(videoID);
Â  Â  isApplyingState = false;
Â  Â  return;
Â  }

Â  // 2. Aplikace pending stavu po naÄtenÃ­
Â  if (pendingState) {
Â  Â  if (localState === YT.PlayerState.PLAYING || localState === YT.PlayerState.PAUSED || localState === YT.PlayerState.BUFFERING || localState === YT.PlayerState.CUED) {
Â  Â  Â  
Â  Â  Â  if (pendingState.playing && localState !== YT.PlayerState.PLAYING) {
Â  Â  Â  Â  player.playVideo();
Â  Â  Â  } else if (!pendingState.playing && localState !== YT.PlayerState.PAUSED) {
Â  Â  Â  Â  player.pauseVideo();
Â  Â  Â  }
Â  Â  Â  
Â  Â  Â  player.seekTo(pendingState.time, true);
Â  Â  Â  pendingState = null;
Â  Â  }
Â  }

Â  // 3. Synchronizace Äasu a stavu (bÄ›Å¾nÃ¡ ÃºdrÅ¾ba)
Â  if (localState === YT.PlayerState.PLAYING || localState === YT.PlayerState.PAUSED || localState === YT.PlayerState.BUFFERING) {
Â  Â  Â  
Â  Â  Â  const delay = (Date.now() - ts) / 1000;
Â  Â  Â  const syncTime = time + delay + 0.2; 
Â  Â  Â  const timeDiff = Math.abs(player.getCurrentTime() - syncTime);

Â  Â  Â  if (timeDiff > 0.5) { 
Â  Â  Â  Â  player.seekTo(syncTime, true);
Â  Â  Â  }
Â  Â  
Â  Â  Â  if (playing && localState !== YT.PlayerState.PLAYING) {
Â  Â  Â  Â  player.playVideo();
Â  Â  Â  } else if (!playing && localState !== YT.PlayerState.PAUSED) {
Â  Â  Â  Â  player.pauseVideo();
Â  Â  Â  }
Â  }

Â  setTimeout(() => { isApplyingState = false; }, 300); 
}


function listenRoom(){
Â  db.ref(`rooms/${room}/users`).on("value", snap=>{
Â  Â  users.innerHTML="";
Â  Â  snap.forEach(u=>{
Â  Â  Â  const li=document.createElement("li");
Â  Â  Â  li.textContent=u.val();
Â  Â  Â  users.appendChild(li);
Â  Â  });
Â  });

Â  db.ref(`rooms/${room}/state`).on("value", snap=>{
Â  Â  applyState(snap.val());
Â  });
}

// ================= VIDEO CONTROLS & ODESÃLÃNÃ =================

function loadVideo(){
Â  const id = extractVideoID(videoUrl.value);
Â  if(!id) return alert("NeplatnÃ½ YouTube odkaz");

  const controlsEnabled = document.getElementById('allowControl').checked;
  if (!isHost && !controlsEnabled) {
      alert("Pouze host nebo povolenÃ½ uÅ¾ivatelÃ© mohou vklÃ¡dat videa.");
      return;
  }
    
Â  db.ref(`rooms/${room}/state`).set({
Â  Â  playing:true,
Â  Â  time:0,
Â  Â  ts:Date.now(),
Â  Â  videoID:id 
Â  });
Â  videoUrl.value = ""; 
}

function onPlayerState(e){
Â  if(isApplyingState || !room || !userRef || e.data === YT.PlayerState.CUED || e.data === YT.PlayerState.ENDED) return; 
  
  const controlsEnabled = document.getElementById('allowControl').checked;
  if (!isHost && !controlsEnabled) {
      return;
  }

Â  if(e.data===YT.PlayerState.PLAYING || e.data===YT.PlayerState.PAUSED){
Â  Â  Â  db.ref(`rooms/${room}/state`).set({
Â  Â  Â  Â  playing:e.data===YT.PlayerState.PLAYING,
Â  Â  Â  Â  time:player.getCurrentTime(),
Â  Â  Â  Â  ts:Date.now(),
Â  Â  Â  Â  videoID:lastVideoID 
Â  Â  Â  });
Â  }
}
</script>

</body>
</html>
